<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Purchase Agent</title>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f0f17">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Purchase">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="app-version" content="2.1">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f0f17',
                            card: '#1a1a2e',
                            border: '#2a2a4a',
                            hover: '#252545',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * { -webkit-tap-highlight-color: transparent; }

        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow { animation: pulse-slow 2s ease-in-out infinite; }

        /* Hide scrollbar but keep scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Horizontal scroll with snap */
        .site-scroll {
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .site-scroll > div {
            scroll-snap-align: start;
        }

        /* Day group toggle */
        .day-toggle::after {
            content: '';
            border: solid currentColor;
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            transition: transform 0.2s;
            margin-left: 8px;
        }
        .day-toggle.collapsed::after {
            transform: rotate(-45deg);
        }

        /* Brand dropdown items - minimum 44px for mobile touch */
        .brand-dropdown-item {
            min-height: 44px;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
        }
        .brand-dropdown-item:hover,
        .brand-dropdown-item:active {
            background-color: rgba(37, 37, 69, 1);
        }

        /* Brand dropdown container */
        #brand-dropdown {
            min-width: 200px;
            background: #1a1a2e;
            border: 1px solid #2d2d44;
            position: absolute !important;
            z-index: 9999 !important;
        }

        /* Ensure parent containers don't clip dropdown - only for form container */
        .bg-dark-card:has(#brand-dropdown),
        .bg-dark-card > .flex:has(#brand-dropdown),
        .bg-dark-card > .flex > .relative:has(#brand-dropdown) {
            overflow: visible !important;
        }

        /* Fallback for browsers without :has() support */
        .bg-dark-card {
            position: relative;
        }

        /* AI Chat Section Styles */
        .ai-chat-section {
            background: #1a1a2e;
            border: 1px solid #2a2a4a;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 0.75rem;
            display: block !important; /* –í—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        }
        .ai-chat-header {
            font-size: 1.125rem;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ai-chat-messages {
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
            space-y: 0.5rem;
        }
        .ai-chat-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .ai-chat-input input {
            flex: 1;
            background: #0f0f17;
            border: 1px solid #2a2a4a;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            color: white;
            font-size: 0.875rem;
        }
        .ai-chat-input input::placeholder {
            color: #6b7280;
        }
        .ai-chat-input input:focus {
            outline: none;
            border-color: #9333ea;
            ring: 2px;
            ring-color: #9333ea;
        }
        .ai-chat-input button {
            padding: 0.5rem 1rem;
            background: linear-gradient(to right, #9333ea, #7c3aed);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .ai-chat-input button:hover {
            opacity: 0.9;
        }
        .ai-chat-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Voice button styles */
        .voice-btn {
            background: transparent;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 8px 12px;
            transition: opacity 0.2s;
        }
        .voice-btn:hover {
            opacity: 0.8;
        }
        .voice-btn.recording {
            animation: pulse 0.5s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }

        /* Mobile-specific fixes */
        @media (max-width: 768px) {
            #brand-dropdown {
                min-width: 200px;
                max-width: calc(100vw - 2rem);
                right: 0;
                left: auto;
            }
            
            /* Ensure dropdown container is visible on mobile */
            .bg-dark-card > .flex > .relative {
                overflow: visible !important;
                z-index: 10;
            }

            /* AI-—á–∞—Ç –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            #ai-chat-section {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                padding: 0.75rem;
            }
            .ai-chat-messages {
                max-height: 250px; /* –ù–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            }
            .ai-chat-input input {
                font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
            }
        }

        @media (min-width: 768px) {
            #brand-dropdown {
                min-width: 250px;
            }
        }
    </style>
</head>
<body class="bg-dark-bg text-gray-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-3 py-4">
        <!-- Header -->
        <header class="mb-4">
            <h1 class="text-xl font-bold text-center bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent">
                AI Purchase Agent
            </h1>
        </header>

        <!-- Input Form -->
        <div class="bg-dark-card rounded-xl p-3 mb-3 border border-dark-border" style="overflow: visible;">
            <div class="flex gap-2 mb-2" style="overflow: visible;">
                <div class="relative flex-1" style="overflow: visible;">
                    <input
                        id="partnumber"
                        type="text"
                        placeholder="–ê—Ä—Ç–∏–∫—É–ª"
                        autocomplete="off"
                        class="w-full bg-dark-bg border border-dark-border rounded-lg px-3 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm"
                    >
                    <div id="history-dropdown" class="hidden absolute top-full left-0 right-0 mt-1 bg-dark-card border border-dark-border rounded-lg shadow-lg z-[9999] max-h-48 overflow-y-auto"></div>
                </div>
                <div class="relative" style="overflow: visible; z-index: 1;">
                    <input
                        id="search-brand"
                        type="text"
                        placeholder="–ë—Ä–µ–Ω–¥"
                        autocomplete="off"
                        class="w-28 bg-dark-bg border border-dark-border rounded-lg px-3 py-2.5 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm"
                    >
                    <div id="brand-dropdown" class="hidden absolute top-full left-0 mt-1 w-48 bg-dark-card border border-dark-border rounded-lg shadow-lg z-[9999] max-h-48 overflow-y-auto" style="position: absolute !important; z-index: 9999 !important;"></div>
                </div>
            </div>
            <div class="flex gap-2">
                <button
                    onclick="createTask()"
                    class="flex-1 py-2.5 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 rounded-lg font-semibold text-sm transition active:scale-95"
                >
                    –ù–∞–π—Ç–∏ —Ü–µ–Ω—ã
                </button>
                <button
                    onclick="loadTasks()"
                    class="px-4 py-2.5 bg-dark-border hover:bg-dark-hover rounded-lg text-lg transition"
                    title="–û–±–Ω–æ–≤–∏—Ç—å"
                >
                    ‚Üª
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="flex justify-between text-xs text-gray-500 mb-3 px-1">
            <span id="stats-total">0 –∞—Ä—Ç–∏–∫—É–ª–æ–≤</span>
            <span id="stats-done" class="text-green-500">‚úì 0</span>
            <span id="stats-pending" class="text-yellow-500">‚è≥ 0</span>
            <span id="stats-error" class="text-red-500">‚úó 0</span>
        </div>

        <!-- Filters -->
        <div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar pb-1">
            <button class="filter-btn active shrink-0 px-3 py-1.5 text-xs rounded-full bg-dark-border transition" data-status="all">–í—Å–µ</button>
            <button class="filter-btn shrink-0 px-3 py-1.5 text-xs rounded-full bg-dark-border transition" data-status="DONE">–ì–æ—Ç–æ–≤–æ</button>
            <button class="filter-btn shrink-0 px-3 py-1.5 text-xs rounded-full bg-dark-border transition" data-status="ERROR">–û—à–∏–±–∫–∏</button>
            <div class="w-px bg-dark-border mx-1"></div>
            <button class="filter-btn active shrink-0 px-3 py-1.5 text-xs rounded-full bg-dark-border transition" data-date="all">–í—Å—ë</button>
            <button class="filter-btn shrink-0 px-3 py-1.5 text-xs rounded-full bg-dark-border transition" data-date="today">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="filter-btn shrink-0 px-3 py-1.5 text-xs rounded-full bg-dark-border transition" data-date="week">–ù–µ–¥–µ–ª—è</button>
        </div>

        <!-- AI Chat Section (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω, —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ –º–µ–∂–¥—É —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –∞—Ä—Ç–∏–∫—É–ª–∞–º–∏) -->
        <div id="ai-chat-section" class="ai-chat-section mb-3">
            <div class="ai-chat-header">üí¨ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
            <div id="ai-chat-messages" class="ai-chat-messages"></div>
            <div id="ai-chat-loading" class="py-3 text-center text-xs text-gray-400 hidden">
                <span>–°–ø—Ä–∞—à–∏–≤–∞—é Perplexity AI...</span>
            </div>
            <div class="ai-chat-input">
                <input type="text" id="ai-chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å...">
                <button id="ai-voice-btn" class="voice-btn">üé§</button>
                <button id="ai-chat-send">‚û§</button>
            </div>
        </div>

        <!-- Tasks Container -->
        <div id="tasks-container" class="space-y-2">
            <!-- Day groups will be inserted here -->
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="py-12 text-center text-gray-500">
            <div class="w-6 h-6 mx-auto mb-3 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden py-12 text-center text-gray-500">
            <p class="text-4xl mb-2">üì¶</p>
            <p class="text-sm">–ù–µ—Ç –∑–∞–¥–∞—á</p>
        </div>
    </div>

    <!-- Brand Selection Modal -->
    <div id="brand-modal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/70" onclick="closeBrandModal()"></div>

        <!-- Modal Content -->
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto bg-dark-card rounded-2xl border border-dark-border overflow-hidden">
            <!-- Header -->
            <div class="px-4 py-3 bg-dark-border/30 border-b border-dark-border">
                <h3 class="text-lg font-semibold text-center">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</h3>
                <p id="brand-modal-partnumber" class="text-sm text-purple-400 text-center mt-1"></p>
            </div>

            <!-- Loading State -->
            <div id="brand-modal-loading" class="py-8 text-center">
                <div class="w-6 h-6 mx-auto mb-3 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-sm text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–µ–Ω–¥–æ–≤ —Å ZZAP...</p>
            </div>

            <!-- Brands List -->
            <div id="brand-modal-list" class="hidden max-h-64 overflow-y-auto">
                <!-- Brands will be inserted here -->
            </div>

            <!-- No Brands Found -->
            <div id="brand-modal-empty" class="hidden py-8 text-center text-gray-500">
                <p class="text-3xl mb-2">üîç</p>
                <p class="text-sm">–ë—Ä–µ–Ω–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                <button onclick="submitTaskWithoutBrand()" class="mt-4 px-4 py-2 bg-dark-border hover:bg-dark-hover rounded-lg text-sm transition">
                    –ò—Å–∫–∞—Ç—å –±–µ–∑ –±—Ä–µ–Ω–¥–∞
                </button>
            </div>

            <!-- Footer -->
            <div class="px-4 py-3 border-t border-dark-border flex justify-end">
                <button onclick="closeBrandModal()" class="px-4 py-2 text-sm text-gray-400 hover:text-white transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        const API = '/api/tasks';

        // State
        let allTasks = [];
        let filteredTasks = [];
        let expandedRows = new Set();
        let collapsedDays = new Set();
        let statusFilter = 'all';
        let dateFilter = 'all';

        // Formatting
        function formatPrice(price) {
            if (!price) return '‚Äî';
            return Math.round(price).toLocaleString('ru-RU') + '‚ÇΩ';
        }

        function formatDayKey(dateStr) {
            if (!dateStr) return 'unknown';
            const d = new Date(dateStr);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function formatDayHeader(dayKey, count) {
            if (dayKey === 'unknown') return `–ë–µ–∑ –¥–∞—Ç—ã ‚Äî ${count}`;
            const [y, m, d] = dayKey.split('-');
            const date = new Date(y, m-1, d);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            let label;
            if (date.toDateString() === today.toDateString()) {
                label = '–°–µ–≥–æ–¥–Ω—è';
            } else if (date.toDateString() === yesterday.toDateString()) {
                label = '–í—á–µ—Ä–∞';
            } else {
                label = `${d}.${m}`;
            }
            return `${label} ‚Äî ${count} –∞—Ä—Ç–∏–∫—É–ª${getPlural(count)}`;
        }

        function getPlural(n) {
            const mod10 = n % 10;
            const mod100 = n % 100;
            if (mod10 === 1 && mod100 !== 11) return '';
            if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) return '–∞';
            return '–æ–≤';
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'DONE': return '<span class="text-green-500">‚úì</span>';
                case 'ERROR': return '<span class="text-red-500">‚úó</span>';
                case 'RUNNING': return '<span class="text-blue-500 animate-pulse-slow">‚óè</span>';
                default: return '<span class="text-yellow-500">‚è≥</span>';
            }
        }

        function getBestPrice(task) {
            const prices = [
                { site: 'zzap', price: task.zzap_min_price },
                { site: 'stparts', price: task.stparts_min_price },
                { site: 'trast', price: task.trast_min_price },
                { site: 'autovid', price: task.autovid_min_price },
                { site: 'autotrade', price: task.autotrade_min_price }
            ].filter(p => p.price);

            if (prices.length === 0) return { site: null, price: null };
            return prices.reduce((a, b) => a.price < b.price ? a : b);
        }

        // Links
        const makeLink = {
            zzap: (p) => `https://www.zzap.ru/public/search.aspx?rawdata=${encodeURIComponent(p)}`,
            stparts: (p) => `https://stparts.ru/search?pcode=${encodeURIComponent(p)}`,
            trast: (p) => `https://trast-zapchast.ru/?s=${encodeURIComponent(p)}`,
            autovid: (p) => `https://auto-vid.com/?s=${encodeURIComponent(p)}&post_type=product`,
            autotrade: (p) => `https://sklad.autotrade.su/search/?type=article&q=${encodeURIComponent(p)}&mode=by_full_article`
        };

        // Filtering
        function applyFilters() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            filteredTasks = allTasks.filter(t => {
                if (statusFilter !== 'all' && t.status !== statusFilter) return false;
                if (dateFilter !== 'all') {
                    const taskDate = new Date(t.created_at);
                    if (dateFilter === 'today' && taskDate < today) return false;
                    if (dateFilter === 'week' && taskDate < weekAgo) return false;
                }
                return true;
            });

            render();
        }

        // Group by day
        function groupByDay(tasks) {
            const groups = {};
            tasks.forEach(t => {
                const key = formatDayKey(t.created_at);
                if (!groups[key]) groups[key] = [];
                groups[key].push(t);
            });

            // Sort days descending (newest first)
            const sortedKeys = Object.keys(groups).sort((a, b) => b.localeCompare(a));
            return sortedKeys.map(key => ({
                day: key,
                tasks: groups[key].sort((a, b) => b.id - a.id) // Sort tasks by id desc
            }));
        }

        // Toggle
        function toggleRow(id) {
            if (expandedRows.has(id)) {
                expandedRows.delete(id);
            } else {
                expandedRows.add(id);
            }
            render();
        }

        function toggleDay(day) {
            if (collapsedDays.has(day)) {
                collapsedDays.delete(day);
            } else {
                collapsedDays.add(day);
            }
            render();
        }

        // Render
        function render() {
            const container = document.getElementById('tasks-container');
            const groups = groupByDay(filteredTasks);

            if (groups.length === 0) {
                container.innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('loading-state').classList.add('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('loading-state').classList.add('hidden');

            // –ï–¥–∏–Ω—ã–π –¥–∏–∑–∞–π–Ω: –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –¥–Ω—è–º
            container.innerHTML = groups.map(g => renderDayGroup(g)).join('');
            updateStats();
        }

        function renderDesktopTable(tasks) {
            return `
                <div class="bg-dark-card rounded-xl border border-dark-border overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-dark-border/50">
                            <tr class="text-left text-gray-400 text-xs uppercase">
                                <th class="px-4 py-3 font-medium">–°—Ç–∞—Ç—É—Å</th>
                                <th class="px-4 py-3 font-medium">–ê—Ä—Ç–∏–∫—É–ª</th>
                                <th class="px-4 py-3 font-medium">–ë—Ä–µ–Ω–¥</th>
                                <th class="px-4 py-3 font-medium text-right text-blue-400">ZZAP</th>
                                <th class="px-4 py-3 font-medium text-right text-green-400">STparts</th>
                                <th class="px-4 py-3 font-medium text-right text-orange-400">Trast</th>
                                <th class="px-4 py-3 font-medium text-right text-purple-400">AutoVID</th>
                                <th class="px-4 py-3 font-medium text-right text-amber-400">AutoTrade</th>
                                <th class="px-4 py-3 font-medium text-right">–õ—É—á—à–∞—è</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-dark-border/50">
                            ${tasks.map(t => renderDesktopRow(t)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderDesktopRow(t) {
            const best = getBestPrice(t);
            const isError = t.status === 'ERROR';

            const priceCell = (price, siteKey, colorClass) => {
                if (!price) return '<span class="text-gray-500">‚Äî</span>';
                const isBest = best.site === siteKey;
                const link = makeLink[siteKey](t.partnumber);
                return `
                    <span class="${isBest ? 'text-green-400 font-bold' : colorClass}">${formatPrice(price)}</span>
                    <a href="${link}" target="_blank" class="ml-1 text-gray-500 hover:text-white">‚Üó</a>
                `;
            };

            return `
                <tr class="${isError ? 'bg-red-500/5' : 'hover:bg-dark-hover/30'}">
                    <td class="px-4 py-3">${getStatusIcon(t.status)}</td>
                    <td class="px-4 py-3 font-semibold">${t.partnumber}</td>
                    <td class="px-4 py-3 text-purple-400">${t.search_brand || t.brand || '‚Äî'}</td>
                    <td class="px-4 py-3 text-right">${priceCell(t.zzap_min_price, 'zzap', 'text-blue-300')}</td>
                    <td class="px-4 py-3 text-right">${priceCell(t.stparts_min_price, 'stparts', 'text-green-300')}</td>
                    <td class="px-4 py-3 text-right">${priceCell(t.trast_min_price, 'trast', 'text-orange-300')}</td>
                    <td class="px-4 py-3 text-right">${priceCell(t.autovid_min_price, 'autovid', 'text-purple-300')}</td>
                    <td class="px-4 py-3 text-right">${priceCell(t.autotrade_min_price, 'autotrade', 'text-amber-300')}</td>
                    <td class="px-4 py-3 text-right font-bold ${best.price ? 'text-green-400' : 'text-gray-500'}">${formatPrice(best.price)}</td>
                </tr>
                ${isError && t.error_message ? `
                    <tr class="bg-red-500/5">
                        <td colspan="9" class="px-4 py-2 text-xs text-red-400">${t.error_message}</td>
                    </tr>
                ` : ''}
            `;
        }

        function renderDayGroup(group) {
            const isCollapsed = collapsedDays.has(group.day);
            const header = formatDayHeader(group.day, group.tasks.length);

            return `
                <div class="bg-dark-card rounded-xl border border-dark-border overflow-hidden">
                    <!-- Day Header -->
                    <div
                        class="day-toggle ${isCollapsed ? 'collapsed' : ''} flex items-center justify-between px-3 py-2.5 bg-dark-border/30 cursor-pointer active:bg-dark-hover"
                        onclick="toggleDay('${group.day}')"
                    >
                        <span class="text-sm font-medium text-gray-300">${header}</span>
                    </div>

                    <!-- Tasks List -->
                    ${!isCollapsed ? `
                        <div class="divide-y divide-dark-border/50">
                            ${group.tasks.map(t => renderTask(t)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderTask(t) {
            const best = getBestPrice(t);
            const isExpanded = expandedRows.has(t.id);
            const isError = t.status === 'ERROR';

            return `
                <div class="${isError ? 'bg-red-500/5' : ''}">
                    <!-- Compact Row -->
                    <div
                        class="flex items-center gap-3 px-3 py-2.5 cursor-pointer active:bg-dark-hover/50"
                        onclick="toggleRow(${t.id})"
                    >
                        <!-- Status -->
                        <div class="text-lg">${getStatusIcon(t.status)}</div>

                        <!-- Partnumber + Brand -->
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-sm truncate">${t.partnumber}</div>
                            ${t.search_brand || t.brand ? `<div class="text-xs text-purple-400 truncate">${t.search_brand || t.brand}</div>` : ''}
                        </div>

                        <!-- Best Price -->
                        <div class="text-right shrink-0">
                            ${best.price
                                ? `<div class="text-green-400 font-bold text-sm">${formatPrice(best.price)}</div>`
                                : `<div class="text-gray-500 text-sm">‚Äî</div>`
                            }
                        </div>

                        <!-- Expand Arrow -->
                        <div class="text-gray-500 text-xs">${isExpanded ? '‚ñ≤' : '‚ñº'}</div>
                    </div>

                    <!-- Expanded Details -->
                    ${isExpanded ? renderExpandedDetails(t, best) : ''}
                </div>
            `;
        }

        function renderExpandedDetails(t, best) {
            const sites = [
                { key: 'zzap', name: 'ZZAP', color: 'blue', price: t.zzap_min_price },
                { key: 'stparts', name: 'STparts', color: 'green', price: t.stparts_min_price },
                { key: 'trast', name: 'Trast', color: 'orange', price: t.trast_min_price },
                { key: 'autovid', name: 'AutoVID', color: 'purple', price: t.autovid_min_price },
                { key: 'autotrade', name: 'AutoTrade', color: 'amber', price: t.autotrade_min_price }
            ];

            // Compact list format: Site name, price, [–û—Ç–∫—Ä—ã—Ç—å] button
            const sitesList = sites.map(s => {
                const isBest = best.site === s.key && s.price;
                const priceText = s.price ? formatPrice(s.price) : '‚Äî';
                const priceDisplay = isBest ? `${priceText} *` : priceText;
                const priceClass = isBest ? 'text-green-400 font-semibold' : (s.price ? 'text-gray-300' : 'text-gray-500');
                const link = makeLink[s.key](t.partnumber);
                return `
                    <div class="flex items-center gap-3 py-1.5 text-sm">
                        <span class="text-${s.color}-400 font-medium w-20 shrink-0">${s.name}</span>
                        <span class="${priceClass} flex-1 text-right">${priceDisplay}</span>
                        <a href="${link}" target="_blank"
                           class="px-2.5 py-1 text-xs bg-dark-border hover:bg-dark-hover rounded transition shrink-0"
                           onclick="event.stopPropagation()">–û—Ç–∫—Ä—ã—Ç—å</a>
                    </div>
                `;
            }).join('');

            const pricesJson = JSON.stringify({
                zzap: t.zzap_min_price,
                stparts: t.stparts_min_price,
                trast: t.trast_min_price,
                autovid: t.autovid_min_price,
                autotrade: t.autotrade_min_price
            }).replace(/"/g, '&quot;');

            return `
                <div class="px-3 pb-3 pt-1">
                    <!-- Sites List -->
                    <div class="space-y-0.5">
                        ${sitesList}
                    </div>

                    <!-- Error Message -->
                    ${t.error_message ? `
                        <div class="mt-2 text-xs text-red-400 bg-red-500/10 rounded p-2">
                            ${t.error_message}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateStats() {
            const total = allTasks.length;
            const done = allTasks.filter(t => t.status === 'DONE').length;
            const pending = allTasks.filter(t => t.status === 'PENDING' || t.status === 'RUNNING').length;
            const error = allTasks.filter(t => t.status === 'ERROR').length;

            document.getElementById('stats-total').textContent = `${total} –∞—Ä—Ç–∏–∫—É–ª${getPlural(total)}`;
            document.getElementById('stats-done').textContent = `‚úì ${done}`;
            document.getElementById('stats-pending').textContent = `‚è≥ ${pending}`;
            document.getElementById('stats-error').textContent = `‚úó ${error}`;
        }

        // API
        async function loadTasks() {
            try {
                const res = await fetch(API);
                allTasks = await res.json();
                applyFilters();
                
                // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                const chatSection = document.getElementById('ai-chat-section');
                const header = chatSection?.querySelector('.ai-chat-header');
                
                if (allTasks.length > 0) {
                    const latestTask = allTasks[0]; // –ü–µ—Ä–≤–∞—è –∑–∞–¥–∞—á–∞ - —Å–∞–º–∞—è –Ω–æ–≤–∞—è
                    if (latestTask.status === 'DONE') {
                        const prices = {
                            zzap: latestTask.zzap_min_price,
                            stparts: latestTask.stparts_min_price,
                            trast: latestTask.trast_min_price,
                            autovid: latestTask.autovid_min_price,
                            autotrade: latestTask.autotrade_min_price
                        };
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç, –Ω–æ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                        aiChatContext = {
                            partnumber: latestTask.partnumber,
                            brand: latestTask.brand || latestTask.search_brand || '',
                            prices: prices
                        };
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
                        if (header) {
                            header.textContent = `üí¨ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî ${latestTask.partnumber}${aiChatContext.brand ? ' (' + aiChatContext.brand + ')' : ''}`;
                        }
                    } else if (header && !aiChatContext) {
                        // –ù–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö –∑–∞–¥–∞—á - –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                        header.textContent = 'üí¨ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç';
                    }
                } else if (header && !aiChatContext) {
                    // –ù–µ—Ç –∑–∞–¥–∞—á - –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    header.textContent = 'üí¨ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç';
                }
                }
            } catch (e) {
                console.error('loadTasks error:', e);
            }
        }

        // Pending partnumber for brand selection
        let pendingPartnumber = null;

        async function createTask() {
            const partnumber = document.getElementById('partnumber').value.trim();
            const searchBrand = document.getElementById('search-brand').value.trim();

            if (!partnumber) {
                document.getElementById('partnumber').focus();
                return;
            }

            // –ï—Å–ª–∏ –±—Ä–µ–Ω–¥ —É–∂–µ —É–∫–∞–∑–∞–Ω - —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—ë–º –∑–∞–¥–∞—á—É
            if (searchBrand) {
                await submitTask(partnumber, searchBrand);
                return;
            }

            // –ò–Ω–∞—á–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –±—Ä–µ–Ω–¥–∞
            pendingPartnumber = partnumber;
            await showBrandModal(partnumber);
        }

        async function showBrandModal(partnumber) {
            const modal = document.getElementById('brand-modal');
            const loading = document.getElementById('brand-modal-loading');
            const list = document.getElementById('brand-modal-list');
            const empty = document.getElementById('brand-modal-empty');

            // Reset state
            loading.classList.remove('hidden');
            list.classList.add('hidden');
            empty.classList.add('hidden');
            list.innerHTML = '';

            // Show modal
            document.getElementById('brand-modal-partnumber').textContent = partnumber;
            modal.classList.remove('hidden');

            try {
                // Fetch brands from API
                const res = await fetch(`/api/brands?partnumber=${encodeURIComponent(partnumber)}`);
                const brands = await res.json();

                loading.classList.add('hidden');

                if (brands.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }

                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –±—Ä–µ–Ω–¥ - —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (brands.length === 1) {
                    closeBrandModal();
                    await submitTask(partnumber, brands[0]);
                    return;
                }

                // Render brands list
                list.innerHTML = brands.map(brand => `
                    <button
                        onclick="selectBrand('${brand.replace(/'/g, "\\'")}')"
                        class="w-full px-4 py-3 text-left hover:bg-dark-hover border-b border-dark-border/50 transition flex items-center justify-between group"
                    >
                        <span class="font-medium">${brand}</span>
                        <span class="text-purple-400 opacity-0 group-hover:opacity-100 transition">‚Üí</span>
                    </button>
                `).join('');

                list.classList.remove('hidden');

            } catch (e) {
                console.error('showBrandModal error:', e);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        function closeBrandModal() {
            document.getElementById('brand-modal').classList.add('hidden');
            pendingPartnumber = null;
        }

        // === AI Chat Block (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –º–µ–∂–¥—É –ø–µ—Ä–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–æ–π –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏) ===
        let aiChatContext = null; // { partnumber, brand, prices }
        let aiChatMessages = []; // [{ role: 'user'|'ai', text: string, sources?: [] }]

        function renderChatMessage(message) {
            const isAI = message.role === 'ai';
            return `
                <div class="flex ${isAI ? 'justify-start' : 'justify-end'} mb-2">
                    <div class="max-w-[80%] ${isAI ? 'bg-purple-600/20 border border-purple-500/30' : 'bg-dark-border'} rounded-lg px-3 py-2">
                        <div class="text-sm text-gray-200 leading-relaxed whitespace-pre-wrap">${message.text}</div>
                        ${message.sources && message.sources.length > 0 ? `
                            <div class="mt-2 pt-2 border-t border-dark-border/50">
                                <p class="text-xs text-gray-500 mb-1">–ò—Å—Ç–æ—á–Ω–∏–∫–∏:</p>
                                <div class="text-xs text-blue-400 space-y-1">
                                    ${message.sources.map(s => `<a href="${s}" target="_blank" class="block hover:underline truncate">${s}</a>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderChat() {
            const container = document.getElementById('ai-chat-messages');
            if (!container) return;
            if (aiChatMessages.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = aiChatMessages.map(msg => renderChatMessage(msg)).join('');
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function addMessageToChat(role, text, sources = null) {
            aiChatMessages.push({ role, text, sources });
            renderChat();
        }

        function removeLastMessage() {
            if (aiChatMessages.length > 0) {
                aiChatMessages.pop();
                renderChat();
            }
        }

        function setChatLoading(isLoading) {
            const loader = document.getElementById('ai-chat-loading');
            if (!loader) return;
            if (isLoading) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        async function initAIChat(partnumber, brand, prices) {
            const chatSection = document.getElementById('ai-chat-section');
            if (!chatSection) return;

            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ —á–∞—Ç –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            chatSection.style.display = 'block';
            chatSection.style.visibility = 'visible';
            chatSection.style.opacity = '1';
            chatSection.classList.remove('hidden');

            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ—Ç –∂–µ - –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
            if (aiChatContext && 
                aiChatContext.partnumber === partnumber && 
                aiChatContext.brand === brand &&
                JSON.stringify(aiChatContext.prices) === JSON.stringify(prices) &&
                aiChatMessages.length > 0) {
                renderChat();
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
            aiChatContext = { partnumber, brand, prices };
            aiChatMessages = [];
            renderChat();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const header = chatSection.querySelector('.ai-chat-header');
            if (header) {
                header.textContent = `üí¨ AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî ${partnumber}${brand ? ' (' + brand + ')' : ''}`;
            }
            
            setChatLoading(true);

            try {
                const response = await fetch('/api/ask-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partnumber, brand, prices })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || '–û—à–∏–±–∫–∞ API');
                }

                const data = await response.json();

                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ data.answer - —Å—Ç—Ä–æ–∫–∞, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç
                const answerText = typeof data.answer === 'string' ? data.answer : JSON.stringify(data.answer);

                aiChatMessages.push({
                    role: 'ai',
                    text: answerText,
                    sources: data.sources
                });
                renderChat();

            } catch (e) {
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, –∏–∑–±–µ–≥–∞–µ–º [object Object]
                const errorText = e?.message || (typeof e === 'string' ? e : String(e)) || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ AI';
                aiChatMessages.push({
                    role: 'ai',
                    text: `–û—à–∏–±–∫–∞: ${errorText}`
                });
                renderChat();
            } finally {
                setChatLoading(false);
                const input = document.getElementById('ai-chat-input');
                if (input) input.focus();
            }
        }

        async function sendAIChatMessage() {
            const input = document.getElementById('ai-chat-input');
            const sendBtn = document.getElementById('ai-chat-send');
            
            if (!input || !sendBtn) {
                console.error('AI Chat: —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }

            const text = input.value.trim();
            if (!text) {
                console.log('AI Chat: –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            console.log('AI Chat: –û—Ç–ø—Ä–∞–≤–∫–∞:', text); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
            
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏
            let currentPartnumber = '';
            let currentBrand = '';
            let currentPrices = null;
            
            if (!aiChatContext) {
                if (allTasks && allTasks.length > 0) {
                    const latestTask = allTasks[0];
                    if (latestTask && latestTask.status === 'DONE') {
                        currentPartnumber = latestTask.partnumber || '';
                        currentBrand = latestTask.brand || latestTask.search_brand || '';
                        currentPrices = {
                            zzap: latestTask.zzap_min_price,
                            stparts: latestTask.stparts_min_price,
                            trast: latestTask.trast_min_price,
                            autovid: latestTask.autovid_min_price,
                            autotrade: latestTask.autotrade_min_price
                        };
                        console.log('AI Chat: –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏');
                    }
                }
            } else {
                currentPartnumber = aiChatContext.partnumber || '';
                currentBrand = aiChatContext.brand || '';
                currentPrices = aiChatContext.prices || null;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            aiChatMessages.push({ role: 'user', text: text });
            input.value = '';
            renderChat();

            // –û—Ç–∫–ª—é—á–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
            input.disabled = true;
            sendBtn.disabled = true;
            setChatLoading(true);

            try {
                const response = await fetch('/api/ask-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        partnumber: currentPartnumber || '',  // –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
                        brand: currentBrand || '',            // –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
                        prices: currentPrices,
                        question: text
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData?.detail || errData?.message || '–û—à–∏–±–∫–∞ API');
                }

                const data = await response.json();
                console.log('AI Chat: –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç', data);

                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ data.answer - —Å—Ç—Ä–æ–∫–∞, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç
                const answerText = typeof data?.answer === 'string' ? data.answer : (data?.answer ? JSON.stringify(data.answer) : '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞');

                // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç AI
                aiChatMessages.push({
                    role: 'ai',
                    text: answerText,
                    sources: data?.sources
                });
                renderChat();

            } catch (e) {
                console.error('AI Chat: –æ—à–∏–±–∫–∞', e);
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, –∏–∑–±–µ–≥–∞–µ–º [object Object]
                const errorText = e?.message || (typeof e === 'string' ? e : String(e)) || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ AI';
                aiChatMessages.push({
                    role: 'ai',
                    text: `–û—à–∏–±–∫–∞: ${errorText}`
                });
                renderChat();
            } finally {
                setChatLoading(false);
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        async function selectBrand(brand) {
            if (!pendingPartnumber) return;
            closeBrandModal();
            await submitTask(pendingPartnumber, brand);
        }

        async function submitTaskWithoutBrand() {
            if (!pendingPartnumber) return;
            closeBrandModal();
            await submitTask(pendingPartnumber, null);
        }

        async function submitTask(partnumber, brand) {
            try {
                const payload = { partnumber };
                if (brand) payload.search_brand = brand;

                await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                saveToHistory(partnumber, brand);

                document.getElementById('partnumber').value = '';
                document.getElementById('search-brand').value = '';
                loadTasks();
            } catch (e) {
                console.error('submitTask error:', e);
            }
        }

        // Event Listeners

        // Status filter
        document.querySelectorAll('[data-status]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-status]').forEach(b => {
                    b.classList.remove('active', 'bg-purple-600');
                    b.classList.add('bg-dark-border');
                });
                btn.classList.add('active', 'bg-purple-600');
                btn.classList.remove('bg-dark-border');
                statusFilter = btn.dataset.status;
                applyFilters();
            });
        });

        // Date filter
        document.querySelectorAll('[data-date]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-date]').forEach(b => {
                    b.classList.remove('active', 'bg-purple-600');
                    b.classList.add('bg-dark-border');
                });
                btn.classList.add('active', 'bg-purple-600');
                btn.classList.remove('bg-dark-border');
                dateFilter = btn.dataset.date;
                applyFilters();
            });
        });

        // Enter to submit
        document.getElementById('partnumber').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                hideHistoryDropdown();
                createTask();
            }
        });
        document.getElementById('search-brand').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                hideBrandDropdown();
                createTask();
            }
        });

        // === –ò–°–¢–û–†–ò–Ø –ê–†–¢–ò–ö–£–õ–û–í ===
        const HISTORY_KEY = 'partnumber_history';
        const MAX_HISTORY = 50;

        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            } catch {
                return [];
            }
        }

        function saveToHistory(partnumber, brand) {
            if (!partnumber) return;
            const entry = brand ? `${partnumber} (${brand})` : partnumber;
            let history = getHistory();
            // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
            history = history.filter(h => h !== entry);
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
            history.unshift(entry);
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
            if (history.length > MAX_HISTORY) {
                history = history.slice(0, MAX_HISTORY);
            }
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function hideHistoryDropdown() {
            const dropdown = document.getElementById('history-dropdown');
            if (dropdown) dropdown.classList.add('hidden');
        }

        function showHistoryDropdown(filter = '') {
            const dropdown = document.getElementById('history-dropdown');
            if (!dropdown) return;

            let history = getHistory();
            if (filter) {
                history = history.filter(h => h.toLowerCase().includes(filter.toLowerCase()));
            }

            if (history.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }

            dropdown.innerHTML = history.slice(0, 10).map(h => `
                <div class="px-3 py-2 hover:bg-purple-600 cursor-pointer text-white text-sm border-b border-dark-border/50 last:border-0"
                     onclick="selectHistoryItem('${h.replace(/'/g, "\\'")}')">
                    ${h}
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
        }

        function selectHistoryItem(item) {
            // –ü–∞—Ä—Å–∏–º "ST-FDR8-087-1 (SAT)" -> partnumber –∏ brand
            const match = item.match(/^(.+?)\s*\((.+)\)$/);
            if (match) {
                document.getElementById('partnumber').value = match[1].trim();
                document.getElementById('search-brand').value = match[2].trim();
            } else {
                document.getElementById('partnumber').value = item;
            }
            hideHistoryDropdown();
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –∏ –≤–≤–æ–¥–µ
        document.getElementById('partnumber').addEventListener('focus', () => {
            showHistoryDropdown(document.getElementById('partnumber').value);
        });

        document.getElementById('partnumber').addEventListener('input', (e) => {
            showHistoryDropdown(e.target.value);
        });

        // –°–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#partnumber') && !e.target.closest('#history-dropdown')) {
                hideHistoryDropdown();
            }
        });

        // === –ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ë–†–ï–ù–î–û–í ===
        const defaultBrands = [
            'SAT', 'Peugeot', 'Citroen', 'Renault', 'BMW', 'Mercedes', 'Audi', 'VW', 'Toyota',
            'Ford', 'Hyundai', 'Kia', 'Nissan', 'Honda', 'Mazda', 'Bosch', 'Febi',
            'Lemforder', 'TRW', 'ATE', 'Sachs', 'LuK', 'SKF', 'Valeo', 'Hella',
            'NGK', 'Denso', 'Mann', 'Mahle', 'Gates', 'Continental', 'Delphi',
            'PEUGEOT CITROEN', 'Groupe PSA', 'Toyopower', 'Taksim', 'TAKSIM', 'BRAVE',
            'CTR', 'Masuma', 'Febest', '555', 'GMB', 'Koyo', 'NTN', 'NSK'
        ];

        function hideBrandDropdown() {
            const dropdown = document.getElementById('brand-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }

        document.getElementById('search-brand').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            const dropdown = document.getElementById('brand-dropdown');

            if (!dropdown) return;

            if (query.length < 2) {
                dropdown.classList.add('hidden');
                return;
            }

            const filtered = defaultBrands.filter(b => b.toLowerCase().includes(query));

            if (filtered.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }

            dropdown.innerHTML = filtered.map(b =>
                `<div class="px-3 py-2 hover:bg-purple-600 cursor-pointer text-white min-h-[44px] flex items-center" onclick="selectBrand('${b}')">${b}</div>`
            ).join('');
            dropdown.classList.remove('hidden');
        });

        window.selectBrand = function(brand) {
            const input = document.getElementById('search-brand');
            const dropdown = document.getElementById('brand-dropdown');
            if (input) input.value = brand;
            if (dropdown) dropdown.classList.add('hidden');
        };

        // Init active filter styles
        document.querySelectorAll('.filter-btn.active').forEach(btn => {
            btn.classList.add('bg-purple-600');
            btn.classList.remove('bg-dark-border');
        });


        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ AI-—á–∞—Ç –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        (function ensureChatVisible() {
            const chatSection = document.getElementById('ai-chat-section');
            if (chatSection) {
                chatSection.style.display = 'block';
                chatSection.style.visibility = 'visible';
                chatSection.style.opacity = '1';
                chatSection.classList.remove('hidden');
            }
        })();

        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è AI-—á–∞—Ç–∞ ===
        (function initChatEventHandlers() {
            const sendBtn = document.getElementById('ai-chat-send');
            const chatInput = document.getElementById('ai-chat-input');
            
            // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
            if (sendBtn) {
                sendBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    sendAIChatMessage();
                });
            }
            
            // Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendAIChatMessage();
                    }
                });
            }
        })();

        // === –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –¥–ª—è AI-—á–∞—Ç–∞ ===
        (function initVoiceInput() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ standalone —Ä–µ–∂–∏–º–∞ iOS PWA
            const isIOSPWA = window.navigator.standalone === true;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const voiceBtn = document.getElementById('ai-voice-btn');
            
            // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–∞ iOS PWA (Web Speech API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
            if (isIOSPWA && voiceBtn) {
                voiceBtn.style.display = 'none';
                return;
            }
            
            if (SpeechRecognition && voiceBtn) {
                const recognition = new SpeechRecognition();
                recognition.lang = 'ru-RU';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                voiceBtn.onclick = () => {
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤—Å–µ –µ—â–µ –≤–∏–¥–Ω–∞
                    if (isIOSPWA) {
                        alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Safari –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.');
                        return;
                    }
                    
                    try {
                        recognition.start();
                        voiceBtn.textContent = 'üî¥';
                        voiceBtn.classList.add('recording');
                    } catch (e) {
                        // –ï—Å–ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                        console.log('Recognition already started');
                    }
                };
                
                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    const input = document.getElementById('ai-chat-input');
                    if (input) {
                        input.value = text;
                        input.focus();
                    }
                };
                
                recognition.onend = () => {
                    voiceBtn.textContent = 'üé§';
                    voiceBtn.classList.remove('recording');
                };
                
                recognition.onerror = (event) => {
                    voiceBtn.textContent = 'üé§';
                    voiceBtn.classList.remove('recording');
                    console.error('Speech recognition error:', event.error);
                };
            } else {
                // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                if (voiceBtn) {
                    voiceBtn.style.display = 'none';
                }
            }
        })();

        // Load
        loadTasks();
        setInterval(loadTasks, 3000);

        // === PWA Versioning ===
        const APP_VERSION = '2.1';
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –∏ –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        (async function checkAppVersion() {
            const storedVersion = localStorage.getItem('app_version');
            
            if (storedVersion !== APP_VERSION) {
                // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è - –æ—á–∏—â–∞–µ–º –≤—Å–µ –∫—ç—à–∏
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(name => caches.delete(name)));
                        console.log('‚úÖ –ö—ç—à–∏ –æ—á–∏—â–µ–Ω—ã –¥–ª—è –≤–µ—Ä—Å–∏–∏', APP_VERSION);
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–µ–π:', e);
                    }
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
                localStorage.setItem('app_version', APP_VERSION);
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                if (storedVersion !== null) {
                    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ –≤–µ—Ä—Å–∏–∏', APP_VERSION);
                    location.reload();
                }
            }
        })();

        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').catch(() => {});
        }
    </script>
</body>
</html>
