<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Purchase Agent</title>

    <!-- PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Purchase">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h2 {
            color: white;
            margin-bottom: 16px;
            text-align: center;
            font-size: 1.6rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        h3 {
            color: white;
            margin: 16px 0 8px;
            font-size: 1.1rem;
        }

        /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
        .input-group {
            background: white;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 14px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            min-height: 48px;
        }

        button:active {
            transform: scale(0.97);
        }

        button.secondary {
            background: #6c757d;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .cards-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        /* –°–≤—ë—Ä–Ω—É—Ç—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card-summary {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .card-summary:hover {
            background: #f8f9fa;
        }

        .card-summary:active {
            background: #e9ecef;
        }

        .card-summary-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .card-summary-id {
            color: #999;
            font-size: 12px;
            flex-shrink: 0;
        }

        .card-summary-partnumber {
            font-weight: 700;
            color: #333;
            flex-shrink: 0;
        }

        .card-summary-brand {
            color: #667eea;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .card-summary-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .card-summary-price {
            font-weight: 700;
            color: #27ae60;
            font-size: 15px;
        }

        .card-summary-price.no-price {
            color: #999;
            font-weight: 400;
        }

        .expand-icon {
            font-size: 12px;
            color: #999;
            transition: transform 0.2s;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .card.expanded .expand-icon {
            transform: rotate(90deg);
        }

        /* –†–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
        .card-details {
            display: none;
            border-top: 1px solid #e0e0e0;
        }

        .card.expanded .card-details {
            display: block;
        }

        .card-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-id {
            color: #999;
            font-size: 12px;
        }

        .card-partnumber {
            font-weight: 700;
            font-size: 1.2em;
            color: #333;
        }

        .card-brand {
            color: #666;
            font-size: 13px;
        }

        .card-filter {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        /* –°—Ç–∞—Ç—É—Å –±–µ–π–¥–∂–∏ */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-DONE { background: #d4edda; color: #155724; }
        .status-ERROR { background: #f8d7da; color: #721c24; }
        .status-PENDING { background: #fff3cd; color: #856404; }
        .status-RUNNING { background: #cce5ff; color: #004085; animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* –õ—É—á—à–∞—è —Ü–µ–Ω–∞ */
        .card-best-price {
            padding: 12px 16px;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .best-price-label {
            color: #155724;
            font-weight: 600;
            font-size: 14px;
        }

        .best-price-value {
            color: #155724;
            font-weight: 700;
            font-size: 1.4em;
        }

        /* –°–ø–∏—Å–æ–∫ —Å–∞–π—Ç–æ–≤ */
        .card-sites {
            padding: 8px 0;
        }

        .site-row {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .site-row:last-child {
            border-bottom: none;
        }

        .site-row.is-best {
            background: #f0fff4;
        }

        .site-icon {
            width: 24px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .site-name {
            width: 80px;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .site-name.zzap { color: #3498db; }
        .site-name.stparts { color: #27ae60; }

        .site-price {
            flex: 1;
            font-weight: 700;
            font-size: 15px;
            color: #333;
        }

        .site-price.is-best {
            color: #27ae60;
        }

        .site-price.not-found {
            color: #999;
            font-weight: 400;
            font-style: italic;
        }

        .site-link {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            color: white;
            transition: opacity 0.2s;
        }

        .site-link:hover {
            opacity: 0.85;
        }

        .site-link.zzap { background: #3498db; }
        .site-link.stparts { background: #27ae60; }

        .best-tag {
            background: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ */
        .card-footer {
            padding: 8px 16px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #666;
        }

        /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
        .empty-state {
            text-align: center;
            color: rgba(255,255,255,0.9);
            padding: 40px 20px;
            font-size: 16px;
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π autocomplete dropdown */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            margin-top: -12px;
            -webkit-overflow-scrolling: touch;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
            user-select: none;
            touch-action: manipulation;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item:active,
        .autocomplete-item.highlighted {
            background: #f0f4ff;
            color: #667eea;
        }

        .autocomplete-item:active {
            background: #e0e7ff;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            h2 {
                font-size: 1.4rem;
            }

            .input-group {
                padding: 12px;
            }

            .card-summary {
                padding: 10px 12px;
                gap: 6px;
            }

            .card-summary-left {
                gap: 6px;
            }

            .card-summary-partnumber {
                font-size: 14px;
            }

            .card-summary-brand {
                font-size: 11px;
            }

            .card-summary-right {
                gap: 6px;
            }

            .card-summary-price {
                font-size: 13px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .card-partnumber {
                font-size: 1.1em;
            }

            .site-name {
                width: 70px;
                font-size: 13px;
            }

            .site-price {
                font-size: 14px;
            }

            .site-link {
                padding: 5px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>AI Purchase Agent</h2>

        <div class="input-group">
            <input id="partnumber" placeholder="–ê—Ä—Ç–∏–∫—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1351PK)" autocomplete="off">
            <div class="autocomplete-wrapper">
                <input id="search-brand" placeholder="–ë—Ä–µ–Ω–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Peugeot) ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ" autocomplete="off">
                <div id="brand-dropdown" class="autocomplete-dropdown"></div>
            </div>
            <div class="btn-group">
                <button onclick="createTask()">–ù–∞–π—Ç–∏</button>
                <button class="secondary" onclick="loadTasks()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>

        <div id="tasks-container" class="cards-container">
            <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <script>
        const API = '/api/tasks';

        // –°–ø–∏—Å–æ–∫ –±—Ä–µ–Ω–¥–æ–≤ –¥–ª—è autocomplete
        const BRANDS = [
            'Peugeot', 'Citroen', 'Renault', 'Toyota', 'Honda', 'Nissan', 'Mazda',
            'Ford', 'Volkswagen', 'BMW', 'Mercedes', 'Audi', 'Opel', 'Chevrolet',
            'Hyundai', 'Kia', 'Mitsubishi', 'Suzuki', 'Subaru', 'Fiat', 'Skoda',
            'Volvo', 'Land Rover', 'Jeep', 'Lada', 'Bosch', 'Valeo', 'Denso',
            'NGK', 'Mann', 'Mahle', 'Febi', 'Lemforder', 'TRW', 'ATE', 'Sachs',
            'LuK', 'Gates', 'Continental', 'SKF', 'SNR', 'FAG', 'INA'
        ];

        // Autocomplete –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤
        const brandInput = document.getElementById('search-brand');
        const brandDropdown = document.getElementById('brand-dropdown');
        let highlightedIndex = -1;

        function showBrandDropdown(filter = '') {
            const filterLower = filter.toLowerCase();
            const filtered = filter
                ? BRANDS.filter(b => b.toLowerCase().includes(filterLower))
                : BRANDS;

            if (filtered.length === 0) {
                brandDropdown.classList.remove('show');
                return;
            }

            highlightedIndex = -1;
            brandDropdown.innerHTML = filtered.map((brand, idx) => `
                <div class="autocomplete-item" data-value="${brand}" data-index="${idx}">${brand}</div>
            `).join('');

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            brandDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                // Touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                item.addEventListener('touchstart', handleItemTouch, { passive: true });
                item.addEventListener('touchend', handleItemSelect);
                // Mouse —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
                item.addEventListener('mousedown', handleItemSelect);
            });

            brandDropdown.classList.add('show');
        }

        function hideBrandDropdown() {
            setTimeout(() => {
                brandDropdown.classList.remove('show');
            }, 150); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã —É—Å–ø–µ–ª —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∫–ª–∏–∫/—Ç–∞—á
        }

        function handleItemTouch(e) {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏
            this.classList.add('highlighted');
        }

        function handleItemSelect(e) {
            e.preventDefault();
            e.stopPropagation();
            const value = this.getAttribute('data-value');
            if (value) {
                brandInput.value = value;
                brandDropdown.classList.remove('show');
                brandInput.blur();
            }
        }

        function selectHighlighted() {
            const items = brandDropdown.querySelectorAll('.autocomplete-item');
            if (highlightedIndex >= 0 && highlightedIndex < items.length) {
                brandInput.value = items[highlightedIndex].getAttribute('data-value');
                brandDropdown.classList.remove('show');
            }
        }

        function updateHighlight(newIndex) {
            const items = brandDropdown.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return;

            // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
            items.forEach(item => item.classList.remove('highlighted'));

            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–Ω–¥–µ–∫—Å
            if (newIndex < 0) newIndex = items.length - 1;
            if (newIndex >= items.length) newIndex = 0;

            highlightedIndex = newIndex;
            items[highlightedIndex].classList.add('highlighted');
            items[highlightedIndex].scrollIntoView({ block: 'nearest' });
        }

        // –°–æ–±—ã—Ç–∏—è –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ –±—Ä–µ–Ω–¥–∞
        brandInput.addEventListener('focus', () => showBrandDropdown(brandInput.value));
        brandInput.addEventListener('input', () => showBrandDropdown(brandInput.value));
        brandInput.addEventListener('blur', hideBrandDropdown);

        brandInput.addEventListener('keydown', (e) => {
            if (!brandDropdown.classList.contains('show')) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                updateHighlight(highlightedIndex + 1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                updateHighlight(highlightedIndex - 1);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (highlightedIndex >= 0) {
                    selectHighlighted();
                } else {
                    brandDropdown.classList.remove('show');
                    createTask();
                }
            } else if (e.key === 'Escape') {
                brandDropdown.classList.remove('show');
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-wrapper')) {
                brandDropdown.classList.remove('show');
            }
        });

        document.addEventListener('touchstart', (e) => {
            if (!e.target.closest('.autocomplete-wrapper')) {
                brandDropdown.classList.remove('show');
            }
        }, { passive: true });

        function formatPrice(price) {
            if (!price) return null;
            return price.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' ‚ÇΩ';
        }

        function makeZzapLink(partnumber) {
            return `https://www.zzap.ru/public/search.aspx?rawdata=${encodeURIComponent(partnumber)}`;
        }

        function makeStpartsLink(partnumber) {
            return `https://stparts.ru/search?pcode=${encodeURIComponent(partnumber)}`;
        }

        // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        const expandedCards = new Set();

        function toggleCard(id) {
            if (expandedCards.has(id)) {
                expandedCards.delete(id);
            } else {
                expandedCards.add(id);
            }
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É
            const cardEl = document.querySelector(`.card[data-id="${id}"]`);
            if (cardEl) {
                cardEl.classList.toggle('expanded', expandedCards.has(id));
            }
        }

        function renderCard(task) {
            const t = task;
            const isExpanded = expandedCards.has(t.id);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª—É—á—à—É—é —Ü–µ–Ω—É —Å—Ä–µ–¥–∏ —Å–∞–π—Ç–æ–≤
            const prices = [];
            if (t.zzap_min_price) prices.push({ site: 'zzap', price: t.zzap_min_price });
            if (t.stparts_min_price) prices.push({ site: 'stparts', price: t.stparts_min_price });

            const bestSite = prices.length > 0
                ? prices.reduce((a, b) => a.price < b.price ? a : b).site
                : null;

            // –ë—Ä–µ–Ω–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (search_brand –∏–ª–∏ brand)
            const displayBrand = t.search_brand || t.brand || '';

            // –¶–µ–Ω–∞ –¥–ª—è —Å–≤—ë—Ä–Ω—É—Ç–æ–≥–æ –≤–∏–¥–∞
            const summaryPrice = t.min_price ? formatPrice(t.min_price) : '‚Äî';

            // –ö–∞—Ä—Ç–æ—á–∫–∞
            let html = `
                <div class="card ${isExpanded ? 'expanded' : ''}" data-id="${t.id}">
                    <div class="card-summary" onclick="toggleCard(${t.id})">
                        <span class="expand-icon">‚ñ∂</span>
                        <div class="card-summary-left">
                            <span class="card-summary-id">#${t.id}</span>
                            <span class="card-summary-partnumber">${t.partnumber}</span>
                            ${displayBrand ? `<span class="card-summary-brand">(${displayBrand})</span>` : ''}
                        </div>
                        <div class="card-summary-right">
                            <span class="status-badge status-${t.status}">${t.status}</span>
                            <span class="card-summary-price ${t.min_price ? '' : 'no-price'}">${summaryPrice}</span>
                        </div>
                    </div>
                    <div class="card-details">
            `;

            // –õ—É—á—à–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (t.min_price) {
                html += `
                    <div class="card-best-price">
                        <span class="best-price-label">–õ—É—á—à–∞—è —Ü–µ–Ω–∞</span>
                        <span class="best-price-value">${formatPrice(t.min_price)}</span>
                    </div>
                `;
            }

            // –°–ø–∏—Å–æ–∫ —Å–∞–π—Ç–æ–≤
            html += `<div class="card-sites">`;

            // ZZAP
            const zzapIsBest = bestSite === 'zzap';
            html += `
                <div class="site-row ${zzapIsBest ? 'is-best' : ''}">
                    <span class="site-icon">üîµ</span>
                    <span class="site-name zzap">ZZAP</span>
                    <span class="site-price ${t.zzap_min_price ? (zzapIsBest ? 'is-best' : '') : 'not-found'}">
                        ${t.zzap_min_price ? formatPrice(t.zzap_min_price) : (t.status === 'DONE' ? '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '‚Äî')}
                    </span>
                    ${zzapIsBest ? '<span class="best-tag">–õ–£–ß–®–ê–Ø</span>' : ''}
                    <a href="${makeZzapLink(t.partnumber)}" target="_blank" class="site-link zzap" onclick="event.stopPropagation()">–û—Ç–∫—Ä—ã—Ç—å</a>
                </div>
            `;

            // STparts
            const stpartsIsBest = bestSite === 'stparts';
            html += `
                <div class="site-row ${stpartsIsBest ? 'is-best' : ''}">
                    <span class="site-icon">üü¢</span>
                    <span class="site-name stparts">STparts</span>
                    <span class="site-price ${t.stparts_min_price ? (stpartsIsBest ? 'is-best' : '') : 'not-found'}">
                        ${t.stparts_min_price ? formatPrice(t.stparts_min_price) : (t.status === 'DONE' ? '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '‚Äî')}
                    </span>
                    ${stpartsIsBest ? '<span class="best-tag">–õ–£–ß–®–ê–Ø</span>' : ''}
                    <a href="${makeStpartsLink(t.partnumber)}" target="_blank" class="site-link stparts" onclick="event.stopPropagation()">–û—Ç–∫—Ä—ã—Ç—å</a>
                </div>
            `;

            html += `</div>`; // card-sites

            // –§—É—Ç–µ—Ä —Å–æ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω–æ–π
            if (t.avg_price) {
                html += `
                    <div class="card-footer">
                        <span>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞:</span>
                        <span>${formatPrice(t.avg_price)}</span>
                    </div>
                `;
            }

            html += `</div></div>`; // card-details, card

            return html;
        }

        async function loadTasks() {
            try {
                const res = await fetch(API);
                const tasks = await res.json();
                const container = document.getElementById('tasks-container');

                if (tasks.length === 0) {
                    container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª –≤—ã—à–µ.</div>';
                    return;
                }

                container.innerHTML = tasks.map(renderCard).join('');
            } catch (e) {
                console.error('loadTasks error:', e);
            }
        }

        async function createTask() {
            const partnumberInput = document.getElementById('partnumber');
            const brandInput = document.getElementById('search-brand');
            const partnumber = partnumberInput.value.trim();
            const searchBrand = brandInput.value.trim();

            if (!partnumber) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª!');
                return;
            }

            try {
                const payload = { partnumber };
                if (searchBrand) {
                    payload.search_brand = searchBrand;
                }

                await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                partnumberInput.value = '';
                brandInput.value = '';
                loadTasks();
            } catch (e) {
                console.error('createTask error:', e);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏!');
            }
        }

        // Enter –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
        document.getElementById('partnumber').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createTask();
            }
        });

        // Enter –¥–ª—è search-brand –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ autocomplete keydown

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        setInterval(loadTasks, 2000);
        loadTasks();

        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .catch((err) => console.error('SW error:', err));
        }
    </script>
</body>
</html>
